services:
  influxdb:
    image: influxdb:2.7
    container_name: timeseries-php-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=password
      - DOCKER_INFLUXDB_INIT_ORG=my-org
      - DOCKER_INFLUXDB_INIT_BUCKET=example_bucket
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-token
    volumes:
      - influxdb-data:/var/lib/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  prometheus:
    image: prom/prometheus:latest
    container_name: timeseries-php-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  graphite:
    image: graphiteapp/graphite-statsd:latest
    container_name: timeseries-php-graphite
    ports:
      - "2003:2003"  # Carbon port for receiving metrics
      - "8080:8080"  # Web interface port for querying metrics
    volumes:
      - graphite-data:/opt/graphite/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3

  rrdcached:
    image: crazymax/rrdcached:latest
    container_name: timeseries-php-rrdcached
    ports:
      - "42217:42217"
    volumes:
      - rrdcached-data:/data/db
      - rrdcached-journal:/data/journal
    environment:
      - TZ=UTC
      - PUID=1000
      - PGID=1000
      - RRDCACHED_BASE_DIR=/data/db
      - RRDCACHED_WRITE_TIMEOUT=1800
      - RRDCACHED_WRITE_JITTER=1800
      - RRDCACHED_WRITE_THREADS=4
      - RRDCACHED_FLUSH_DEAD_DATA_INTERVAL=3600
    # fix file permissions
    command: >
      sh -c "chown 1000:1000 /data/db /data/journal && exec /init"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "42217"]
      interval: 30s
      timeout: 10s
      retries: 3

  # opentsdb (disabled by default)
  # opentsdb:
  #   image: petergrace/opentsdb-docker:latest
  #   container_name: timeseries-php-opentsdb
  #   ports:
  #     - "4242:4242"
  #   environment:
  #     - HBASE_CONF=/etc/hbase
  #   volumes:
  #     - opentsdb-data:/data
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:4242"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # timescaledb (disabled by default)
  # timescaledb:
  #   image: timescale/timescaledb:latest-pg14
  #   container_name: timeseries-php-timescaledb
  #   ports:
  #     - "5432:5432"
  #   environment:
  #     - POSTGRES_USER=postgres
  #     - POSTGRES_PASSWORD=secret
  #     - POSTGRES_DB=timeseries
  #   volumes:
  #     - timescaledb-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD", "pg_isready", "-U", "postgres"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

volumes:
  influxdb-data:
  prometheus-data:
  graphite-data:
  rrdcached-data:
  rrdcached-journal:
  opentsdb-data:
  timescaledb-data:
